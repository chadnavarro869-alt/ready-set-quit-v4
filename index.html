<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Ready Set Quit</title>

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Ready Set Quit" />

<style>
:root{
  --bg:#f6f7fb;
  --text:#12121a;
  --card:#ffffff;
  --panel:#f1f3f8;
  --border:#d8dbe6;
  --accent:#2b6cff;
  --muted:#6b7280;
  --btn:#12121a;
  --btnText:#ffffff;
  --shadow:0 14px 36px rgba(0,0,0,.12);
}
[data-theme="dark"]{
  --bg:#0b0c10;
  --text:#e8e8e8;
  --card:#12141a;
  --panel:#0f1117;
  --border:#262a35;
  --accent:#7cf3c7;
  --muted:#9aa0ad;
  --btn:#e8e8e8;
  --btnText:#0b0c10;
  --shadow:0 14px 36px rgba(0,0,0,.35);
}

*{ box-sizing:border-box; }
body{
  margin:0;
  padding:16px;
  font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;
  background: radial-gradient(1200px 800px at 20% 0%, rgba(43,108,255,.10), transparent 55%),
              radial-gradient(900px 600px at 90% 10%, rgba(124,243,199,.10), transparent 50%),
              var(--bg);
  color:var(--text);
  transition: background .2s ease, color .2s ease;
}
.app{ max-width:580px; margin:0 auto; }

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;
  box-shadow:var(--shadow);
  margin-bottom:14px;
}

.topbar{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
}
h1{ margin:0 0 4px; font-size:24px; }
.sub{ margin:0; color:var(--muted); font-size:13px; line-height:1.35; }

.themeBtn{
  font-size:12px;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  font-weight:800;
  cursor:pointer;
}

.grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px; }
@media(max-width:540px){ .grid{ grid-template-columns:1fr; } }

.box{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:16px;
  padding:12px;
}

.label{ font-size:12px; color:var(--muted); margin-bottom:6px; }
.big{ font-size:36px; font-weight:900; letter-spacing:.6px; }
.note{ font-size:12px; color:var(--muted); margin-top:6px; }

.pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  font-size:12px;
  background: color-mix(in srgb, var(--card) 85%, transparent 15%);
  margin:6px 6px 0 0;
}
.pill b{ font-size:13px; }

.msg{
  padding:12px;
  border-radius:16px;
  border:1px solid var(--border);
  background: linear-gradient(135deg,
              color-mix(in srgb, var(--panel) 85%, var(--accent) 15%),
              var(--panel));
  font-weight:800;
}

.hr{ height:1px; background:var(--border); margin:12px 0; }

.row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

button{
  padding:12px 14px;
  border-radius:14px;
  border:1px solid var(--border);
  background:var(--btn);
  color:var(--btnText);
  font-weight:900;
  cursor:pointer;
}
button.secondary{
  background:var(--card);
  color:var(--text);
  font-weight:900;
}
button.danger{
  background:var(--card);
  color:#e63b3b;
  font-weight:900;
}

select{
  padding:10px;
  border-radius:12px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
}

.toast{
  position:fixed;
  left:50%;
  bottom:16px;
  transform:translateX(-50%);
  background:var(--card);
  color:var(--text);
  border:1px solid var(--border);
  border-radius:16px;
  padding:10px 14px;
  box-shadow:var(--shadow);
  font-weight:900;
  opacity:0;
  pointer-events:none;
  transition:opacity .2s ease, transform .2s ease;
}
.toast.show{
  opacity:1;
  transform:translateX(-50%) translateY(-6px);
}
</style>
</head>

<body>
<div class="app" id="app" data-theme="light">

  <div class="card">
    <div class="topbar">
      <div>
        <h1>Ready Set Quit</h1>
        <p class="sub">Delay loop + minute streaks. Rule: “later than last time.”</p>
      </div>
      <button class="themeBtn" id="themeBtn" type="button">Dark</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="label">Next window opens in</div>
      <div class="big" id="countdown">--:--</div>
      <div class="note" id="windowNote">Press Start to begin.</div>

      <div>
        <span class="pill">Streak: <b id="streakMin">0</b> min</span>
        <span class="pill">Best: <b id="bestMin">0</b> min</span>
      </div>
    </div>

    <div class="card">
      <div class="label">Today</div>
      <div>
        <span class="pill">Smoked: <b id="smokedToday">0</b></span>
        <span class="pill">Avoided: <b id="avoidedToday">0</b></span>
        <span class="pill">Win rate: <b id="winRateToday">—</b></span>
      </div>

      <div class="hr"></div>

      <div class="label">Last 7 days</div>
      <div>
        <span class="pill">Smoked: <b id="smoked7">0</b></span>
        <span class="pill">Avoided: <b id="avoided7">0</b></span>
      </div>
    </div>
  </div>

  <div class="card msg" id="messageBox">Win the next 5 minutes. Then do it again.</div>

  <div class="card">
    <div class="row">
      <button id="startBtn" type="button">Start</button>
      <button class="secondary" id="iSmokedBtn" type="button">I smoked</button>
      <button class="secondary" id="iWaitedBtn" type="button">I waited</button>
      <button class="secondary" id="nudgeBtn" type="button">Nudge +5m</button>
      <button class="danger" id="resetBtn" type="button">Reset day</button>
    </div>

    <div class="hr"></div>

    <div class="row">
      <label class="sub">Base</label>
      <select id="baseInterval">
        <option value="30">30 min</option>
        <option value="45">45 min</option>
        <option value="60" selected>60 min</option>
        <option value="75">75 min</option>
        <option value="90">90 min</option>
        <option value="120">120 min</option>
      </select>

      <label class="sub">Lag</label>
      <select id="lagWindow">
        <option value="0">±0</option>
        <option value="3">±3</option>
        <option value="5" selected>±5</option>
        <option value="10">±10</option>
        <option value="15">±15</option>
      </select>
    </div>

    <p class="sub" style="margin-top:12px;">
      Tip: If the window is open and you still wait, that’s a “I waited” win.
    </p>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const STATE_KEY = "rsq_v4_nomoney";

  // Local date key (avoids UTC day-flip issues)
  const ymdLocal = (d = new Date()) => {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const da = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${da}`;
  };
  const dayKey = (d = new Date()) => "rsq_day_" + ymdLocal(d);

  const MSG = [
    "Win the next 5 minutes. Then do it again.",
    "Cravings peak and fall. Your job is to outlast the peak.",
    "You’re training delay, not perfection.",
    "Every minute you wait is real progress.",
    "You’re not owned by this. Prove it for 5 more minutes."
  ];
  const pickMsg = () => MSG[Math.floor(Math.random() * MSG.length)];

  const toast = (text, ms = 1400) => {
    const t = $("toast");
    if (!t) return;
    t.textContent = text;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), ms);
  };

  function loadState() {
    try {
      const raw = localStorage.getItem(STATE_KEY);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      return obj && typeof obj === "object" ? obj : null;
    } catch {
      return null;
    }
  }

  function defaultState() {
    return {
      running: false,
      nextAt: null,
      windowMs: null,
      baseMinutes: 60,
      lagMinutes: 5,
      // minute streaks
      streakMinutes: 0,
      bestMinutes: 0,
      // daily counters
      smoked: {},
      avoided: {},
      // theme
      theme: "light"
    };
  }

  function saveState(s) {
    localStorage.setItem(STATE_KEY, JSON.stringify(s));
  }

  let s = loadState() || defaultState();

  // ---- UI init (safe even if elements change) ----
  const app = $("app");
  const themeBtn = $("themeBtn");
  if (app) app.dataset.theme = s.theme === "dark" ? "dark" : "light";
  if (themeBtn) themeBtn.textContent = (s.theme === "dark") ? "Light" : "Dark";

  const baseSel = $("baseInterval");
  const lagSel = $("lagWindow");
  if (baseSel) baseSel.value = String(s.baseMinutes || 60);
  if (lagSel) lagSel.value = String(s.lagMinutes || 5);

  function scheduleNext() {
    // pull latest settings from UI
    if (baseSel) s.baseMinutes = Number(baseSel.value || 60);
    if (lagSel) s.lagMinutes = Number(lagSel.value || 5);

    const lag = isFinite(s.lagMinutes) ? s.lagMinutes : 5;
    const base = isFinite(s.baseMinutes) ? s.baseMinutes : 60;

    const jitter = (Math.random() * 2 - 1) * lag;
    const minutes = Math.max(5, base + jitter);
    const ms = Math.round(minutes * 60000);

    s.windowMs = ms;
    s.nextAt = Date.now() + ms;
    s.running = true;

    saveState(s);
  }

  function fmt(ms) {
    const total = Math.max(0, Math.floor(ms / 1000));
    const m = Math.floor(total / 60);
    const sec = total % 60;
    return String(m).padStart(2, "0") + ":" + String(sec).padStart(2, "0");
  }

  function getTodayCounts() {
    const k = dayKey();
    return {
      k,
      smoked: s.smoked[k] || 0,
      avoided: s.avoided[k] || 0
    };
  }

  function getLast7() {
    let smoked = 0, avoided = 0;
    for (let i = 0; i < 7; i++) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      const k = dayKey(d);
      smoked += s.smoked[k] || 0;
      avoided += s.avoided[k] || 0;
    }
    return { smoked, avoided };
  }

  function render() {
    // counts
    const t = getTodayCounts();
    const l7 = getLast7();

    const smokedTodayEl = $("smokedToday");
    const avoidedTodayEl = $("avoidedToday");
    const winRateEl = $("winRateToday");

    if (smokedTodayEl) smokedTodayEl.textContent = String(t.smoked);
    if (avoidedTodayEl) avoidedTodayEl.textContent = String(t.avoided);

    const total = t.smoked + t.avoided;
    if (winRateEl) winRateEl.textContent = total ? (Math.round((t.avoided / total) * 100) + "%") : "—";

    const smoked7El = $("smoked7");
    const avoided7El = $("avoided7");
    if (smoked7El) smoked7El.textContent = String(l7.smoked);
    if (avoided7El) avoided7El.textContent = String(l7.avoided);

    // streak minutes
    const streakEl = $("streakMin");
    const bestEl = $("bestMin");
    if (streakEl) streakEl.textContent = String(s.streakMinutes || 0);
    if (bestEl) bestEl.textContent = String(s.bestMinutes || 0);

    // timer
    const countdownEl = $("countdown");
    const noteEl = $("windowNote");

    if (!s.running || !s.nextAt) {
      if (countdownEl) countdownEl.textContent = "--:--";
      if (noteEl) noteEl.textContent = "Press Start to begin.";
      return;
    }

    const rem = s.nextAt - Date.now();
    if (countdownEl) countdownEl.textContent = fmt(rem);

    if (rem <= 0) {
      if (noteEl) noteEl.textContent = "Window open. If you can wait anyway, hit “I waited.”";
    } else {
      if (noteEl) noteEl.textContent = "Random lag is active.";
    }
  }

  // ---- Events (safe guards) ----
  const startBtn = $("startBtn");
  const smokedBtn = $("iSmokedBtn");
  const waitedBtn = $("iWaitedBtn");
  const nudgeBtn = $("nudgeBtn");
  const resetBtn = $("resetBtn");
  const msgBox = $("messageBox");

  if (startBtn) startBtn.addEventListener("click", () => {
    scheduleNext();
    if (msgBox) msgBox.textContent = pickMsg();
    toast("Started.");
  });

  if (smokedBtn) smokedBtn.addEventListener("click", () => {
    const { k, smoked, avoided } = getTodayCounts();
    s.smoked[k] = smoked + 1;

    // smoking breaks the streak
    s.streakMinutes = 0;

    saveState(s);
    scheduleNext();
    if (msgBox) msgBox.textContent = "Logged. Reset the loop. Next window.";
    toast("Logged: smoked.");
    render();
  });

  if (waitedBtn) waitedBtn.addEventListener("click", () => {
    const { k, smoked, avoided } = getTodayCounts();
    s.avoided[k] = avoided + 1;

    // Add streak minutes: count the window length we just waited through (rounded, min 1)
    const pushedMin = Math.max(1, Math.round(((s.windowMs || (s.baseMinutes * 60000)) || 60000) / 60000));
    s.streakMinutes = (s.streakMinutes || 0) + pushedMin;
    if ((s.streakMinutes || 0) > (s.bestMinutes || 0)) s.bestMinutes = s.streakMinutes;

    saveState(s);
    scheduleNext();
    if (msgBox) msgBox.textContent = `You waited. +${pushedMin} min. Total streak: ${s.streakMinutes} min.`;
    toast(`WIN: +${pushedMin} min`);
    render();
  });

  if (nudgeBtn) nudgeBtn.addEventListener("click", () => {
    if (s.nextAt) {
      s.nextAt += 5 * 60000;
      saveState(s);
      toast("Nudge: +5 min");
      render();
    } else {
      toast("Start first.");
    }
  });

  if (resetBtn) resetBtn.addEventListener("click", () => {
    if (!confirm("Reset TODAY’s counts?")) return;
    const k = dayKey();
    s.smoked[k] = 0;
    s.avoided[k] = 0;
    saveState(s);
    toast("Day reset.");
    render();
  });

  if (baseSel) baseSel.addEventListener("change", () => {
    s.baseMinutes = Number(baseSel.value || 60);
    saveState(s);
  });
  if (lagSel) lagSel.addEventListener("change", () => {
    s.lagMinutes = Number(lagSel.value || 5);
    saveState(s);
  });

  if (themeBtn) themeBtn.addEventListener("click", () => {
    const next = (s.theme === "dark") ? "light" : "dark";
    s.theme = next;
    if (app) app.dataset.theme = next;
    themeBtn.textContent = (next === "dark") ? "Light" : "Dark";
    saveState(s);
    toast("Theme: " + next);
  });

  // initial render + ticker
  render();
  setInterval(render, 500);
})();
</script>
</body>
</html>

